# url

https://aistudio.google.com/prompts/1gW-SJSPYy1D29QxEWU31MVY08erK_vaK

Of course. Here is a technical design document for the website migration project, based on the provided requirements, codebase analysis, and implementation plan.

---

### **Technical Design Document: Website Migration to Astro**

**Version:** 1.0
**Date:** August 12, 2025
**Author:** Gemini

#### **1. Introduction**

This document provides the technical blueprint for migrating the personal academic website of Stephen Butterfill from the legacy Docpad static site generator to the modern Astro framework. It outlines the proposed architecture, component design, content migration strategy, and build processes required to meet the functional and non-functional requirements detailed in `requirements-next-version-04.md`. The primary goal is to create a performant, maintainable, and accessible static website hosted on a modern static hosting provider.

---

#### **2. Architecture Overview**

The new architecture is designed for performance, type-safety, and ease of content management. It leverages Astro for static site generation and Svelte for client-side "islands of interactivity."

**2.1. System Diagram**

```
┌─────────────────────────┐      ┌───────────────────┐      ┌───────────────────┐
│ src/content/            │      │ src/layouts/      │      │ src/components/   │
│  ├─ writing/*.md         │      │  └─ BaseLayout.astro │      │  ├─ CommandPalette.svelte │
│  ├─ talks/*.md           │───> │  └─ PageLayout.astro │───> │  ├─ CopyForChat.svelte    │
│  └─ teaching/*.md        │      └───────────────────┘      │  └─ Slides.astro        │
└─────────────────────────┘                                 └───────────────────┘
           │                                                         │ (client:load)
           ▼                                                         ▼
┌─────────────────────────┐      ┌──────────────────────────────────────────────────┐
│ src/pages/              │      │ dist/ (Static Output)                            │
│  ├─ writing/[...slug].astro │───> │  ├─ writing/joint-action/index.html              │
│  ├─ talks/[...slug].astro   │      │  ├─ talks/some-talk/index.html                   │
│  └─ index.astro          │      │  ├─ assets/, js/, css/                           │
└─────────────────────────┘      │  └─ llms.txt, _redirects                         │
                                 └──────────────────────────────────────────────────┘
```

**2.2. Architectural Components**

*   **Framework:** **Astro** will serve as the primary static site generator. Its "zero JS by default" approach ensures optimal performance (NFR-4, NFR-5). It will be responsible for fetching data from content collections, rendering pages, and hydrating interactive components.
*   **Content Source:** All content will be stored in `src/content/` using **Astro Content Collections**. This provides a type-safe API for querying content. Schemas will be defined for `writing`, `talks`, and `teaching` to enforce data consistency (addressing C-3).
*   **Routing & Page Generation:** Astro's file-based routing will be used.
    *   Static pages like the homepage (`src/pages/index.astro`) and list pages (`src/pages/writing.astro`) will be created directly.
    *   Dynamic pages for individual content items will be generated using dynamic routes (e.g., `src/pages/writing/[...slug].astro`).
*   **Interactivity:** **Svelte** will be used for all client-side interactive components, implemented as "islands" using Astro's `client:*` directives. This ensures that JavaScript is only shipped to the browser when and where it is needed.
*   **Styling:** **Tailwind CSS** will be used for all styling, configured via `tailwind.config.cjs`. This utility-first approach aligns with the component-based architecture and the minimalist aesthetic (NFR-2).
*   **Static Assets:** All public assets (PDFs, images, etc.) will be placed in the `public/` directory. The migration script will be responsible for copying and organizing these assets.

---

#### **3. Component Design (Svelte & Astro)**

The following components will be created to meet the functional requirements.

**3.1. Command Palette (`src/components/CommandPalette.svelte`)**

This component addresses FR-19, FR-20, and FR-21 and is a key area of complexity (C-4).

*   **Props:**
    *   `items: { title: string, url: string, type: 'writing' | 'talk' | 'teaching' | 'page' }[]`: A JSON array of all navigable pages, generated by Astro at build time.
    *   `contextualActions: { label: string, action: () => void, shortcut?: string }[] | null`: An array of actions specific to the current page, passed from the parent Astro component.
*   **State Management (Internal):**
    *   `isOpen: boolean`: Controls visibility.
    *   `searchQuery: string`: The user's input for fuzzy searching.
    *   `filteredItems: any[]`: The list of items matching the search query.
    *   `selectedIndex: number`: The currently highlighted item for keyboard navigation.
*   **Functionality:**
    *   A global keydown listener (`Cmd/Ctrl+K`) will toggle the `isOpen` state.
    *   Fuzzy search will be implemented using a lightweight client-side library to filter `items`.
    *   Navigation will be handled client-side via `window.location.href`.
    *   Contextual actions (e.g., "Download PDF") will execute the `action` function passed in the `contextualActions` prop.
*   **Astro Integration:**
    *   The main layout (`BaseLayout.astro`) will fetch all content from collections at build time, format it into the `items` array, and pass it as a JSON string prop to the Svelte component.
    *   The component will be loaded with the `client:load` directive to ensure it is interactive as soon as the page loads.
    *   On a publication page (`writing/[...slug].astro`), the Astro component will define the specific actions (e.g., a JavaScript function to trigger a PDF download) and pass them to the Svelte component.

**3.2. "Copy for Chat" Button (`src/components/CopyForChat.svelte`)**

This component addresses FR-18.

*   **Props:**
    *   `contentToCopy: string`: The pre-formatted, plain-text content to be copied.
*   **Functionality:**
    *   On click, the component will use the `navigator.clipboard.writeText()` API to copy the `contentToCopy` prop to the clipboard.
    *   It will provide visual feedback to the user (e.g., changing the button text to "Copied!").
*   **Astro Integration:**
    *   The Astro page template (e.g., `writing/[...slug].astro`) will query the full content of the publication/talk.
    *   It will then format this content into the specified plain-text format before rendering the Svelte component:
        ```plaintext
        Title: [Title]
        Authors: [Authors]
        Year: [Year]
        Journal: [Journal]

        ## Abstract
        [Abstract Content]

        ---

        ## Full Text
        [Full Text Content]
        ```

**3.3. Sidebar (`src/components/Sidebar.astro`)**

This component addresses FR-2. The scroll-spying logic will be handled by a client-side `<script>` tag within the Astro component, as a full Svelte component is not necessary.

*   **Logic:**
    *   An `IntersectionObserver` will be initialized client-side.
    *   It will be configured to observe the main section containers on the homepage (e.g., `<section id="writing">`).
    *   When a section enters the viewport, the observer's callback will add an `active` class to the corresponding link in the sidebar navigation and remove it from others. This is more performant than a scroll event listener.

---

#### **4. Content Migration Specification**

This section details the logic for the one-time migration script (Requirement 3.1) to de-risk the process (C-1, C-3, C-5).

**4.1. Frontmatter Mapping**

The script will parse CSON from the `---` block of each source file and convert it to the following standardized YAML schema.

| Old Field (CSON) | New Field (YAML) | Type | Transformation Rule |
| :--- | :--- | :--- | :--- |
| `title` | `title` | `string` | Direct mapping. |
| `authors` | `authors` | `string` | Direct mapping. |
| `date` | `pubDate` | `Date` | Standardize to `YYYY-MM-DD` format. |
| `date_end` | `endDate` | `Date` | (For talks) Create optional `endDate` field. |
| `year` | `year` | `number` | Direct mapping. |
| `journal` | `journal` | `string` | Direct mapping. |
| `booktitle` | `booktitle` | `string` | Direct mapping. |
| `volume`, `number`, `pages` | `volume`, `number`, `pages` | `string` | Direct mapping. |
| `doi` | `doi` | `string` | Direct mapping. |
| `pdf: true` | `pdfUrl` | `string` | Generate a root-relative path, e.g., `/pdf/publication-slug.pdf`. |
| `handout: true` | `handoutUrl` | `string` | Generate a root-relative path, e.g., `/pdf/talks/talk-slug.handout.pdf`. |
| `slides: true` | `slidesUrl` | `string` | Generate a root-relative path, e.g., `/pdf/talks/talk-slug.slides.pdf`. |
| `deckslides: true` | `slideImages` | `string[]` | Script will find all images in the corresponding `img/` dir and create an array of their new public paths. |
| `abstract` | (N/A) | `string` | The abstract will be moved from frontmatter to become the main body content under an `## Abstract` heading. |
| `layout` | (N/A) | `string` | Discard. Astro will handle layouts. |
| `isPublication`, `isTalk` | (N/A) | `boolean` | Discard. The content collection (`writing`, `talks`) defines the type. |

**4.2. Content Body Conversion Rules**

*   **`.html.md` & `.html` files:** The body content (Markdown or HTML) will be preserved and placed after the new YAML frontmatter.
*   **`.jade` files:** To mitigate the risk of complex syntax conversion (C-1), the script will **not** attempt a direct Jade-to-Markdown conversion. Instead, it will:
    1.  Use a `pug` (the successor to Jade) library to render the content of each `.jade` file into a static HTML string.
    2.  This rendered HTML will be treated as the body content for the new Markdown file.
    3.  The script will log any files where the Pug renderer fails, flagging them for manual review. Layout-specific Jade logic (e.g., `extends layout`) will be ignored, as the goal is to extract content only.

**4.3. Asset Handling and Path Rewriting**

1.  The script will scan all source files for relative links to assets (e.g., PDFs, images).
2.  It will copy every unique asset found into a corresponding folder within the new `public/` directory (e.g., `public/pdf/`, `public/img/`).
3.  File names will be sanitized to be URL-friendly.
4.  All asset links within the newly generated Markdown files will be rewritten as root-relative paths (e.g., `[handout](/pdf/talks/my-talk-handout.pdf)`).

**4.4. Redirect Generation (NFR-12, NFR-13)**

1.  The script will maintain a map of old URLs to new URLs.
2.  For each source file (e.g., `src/documents/writing/joint_action_development.html`), it will construct the legacy URL path (`/writing/joint_action_development.html`).
3.  It will generate the new slug from the filename (e.g., `joint-action-development`).
4.  It will construct the new URL path (`/writing/joint-action-development/`).
5.  It will write a line to `public/_redirects` in the format: `/writing/joint_action_development.html /writing/joint-action-development/ 301`.
6.  This process will be repeated for all content files to create a comprehensive redirect map.

---

#### **5. `deck.js` Migration Strategy (FR-13)**

The recommended high-effort **Option B** will be implemented to ensure a modern, responsive, and maintainable solution, addressing the risks of the legacy `deck.js` implementation (C-2).

1.  **Identify Content:** The migration script will identify talks that used `deck.js` by checking for `slides: true` and the presence of an associated image directory (e.g., `src/documents/img/talks/heidelberg_2011/`).
2.  **Asset Migration:** The script will copy all slide images to a new corresponding directory in `public/img/talks/`.
3.  **Frontmatter Update:** The script will add a `slideImages` array to the talk's YAML frontmatter, containing the new root-relative paths to the copied images.
4.  **Component (`src/components/Slides.astro`):**
    *   A new Astro component will be created to host the slide deck.
    *   It will accept a prop: `images: string[]`.
    *   It will use the **Reveal.js** library, initialized via a client-side `<script>` tag.
    *   The component will iterate through the `images` prop to generate the necessary `<section>` tags for Reveal.js.
5.  **Integration:** The talk detail page (`src/pages/talks/[...slug].astro`) will conditionally render the `<Slides />` component if the `slideImages` array is present in the page's frontmatter.

---

#### **6. Build & Deployment Process**

The process will be streamlined for simplicity and compatibility with any static hosting provider (NFR-7, NFR-8).

*   **Build Command:** The primary build command will be `npm run build`.
*   **Custom Build Script (`scripts/prebuild.mjs`):** A Node.js script will be created to handle pre-build tasks. This script will be responsible for generating the `llms.txt` file (FR-17) by reading from the `src/content/writing` collection. The `package.json` will be updated: `"build": "node ./scripts/prebuild.mjs && astro build"`.
*   **Output:** The build process will generate a fully static site in the `dist/` directory.
*   **Deployment:** The contents of the `dist/` directory will be deployed. For hosting on AWS, this involves syncing the directory to an S3 bucket configured for static website hosting, with a CloudFront distribution for caching and HTTPS. The `_redirects` file will require configuration of routing rules or a Lambda@Edge function to implement the 301 redirects.